<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>MQTT 127x127 Grid</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #121212;
      text-align: center;
      color: white;
      margin: 0;
      padding: 20px;
    }

    h2 {
      color: white;
      margin-bottom: 10px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(127, 6px);
      gap: 0; /* Remove gaps between boxes */
      margin: 20px auto;
      width: fit-content;
    }

    .cell {
      width: 6px;
      height: 6px;
      background: #333;
    }

    .axis {
      background: #555 !important;
    }

    .active {
      background: #4caf50 !important;
    }

    #status {
      font-size: 0.9em;
      color: #aaa;
    }
  </style>
</head>
<body>
  <h2>MQTT 127Ã—127 Grid</h2>
  <p>Status: <span id="status">Connecting...</span></p>
  <div id="grid" class="grid"></div>

  <script>
    const gridSize = 127;
    const center = Math.floor(gridSize / 2);
    const gridEl = document.getElementById("grid");
    const cells = [];

    // Create grid
    for (let y = 0; y < gridSize; y++) {
      for (let x = 0; x < gridSize; x++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        if (x === center || y === center) {
          cell.classList.add("axis");
        }
        gridEl.appendChild(cell);
        cells.push(cell);
      }
    }

    function highlight(x, y) {
      cells.forEach((c, i) => {
        const cx = i % gridSize;
        const cy = Math.floor(i / gridSize);
        c.classList.toggle("active", x === cx && y === cy);
      });
    }

    // MQTT Setup
    const client = mqtt.connect("2557a86661894ebd8ac6bd385c47461d.s1.eu.hivemq.cloud:8883", {
      username: "mesh0",
      password: "WhoareWe123"
    });

    client.on('connect', () => {
      document.getElementById("status").textContent = "Connected!";
      client.subscribe("mesh/coords");
    });

    client.on('message', (topic, message) => {
      try {
        const { x, y } = JSON.parse(message.toString());
        console.log("Received coords:", x, y);
        highlight(x, y);
      } catch (err) {
        console.error("Invalid MQTT payload", err);
      }
    });

    client.on('error', err => {
      document.getElementById("status").textContent = "MQTT Error";
      console.error(err);
    });
  </script>
</body>
</html>
